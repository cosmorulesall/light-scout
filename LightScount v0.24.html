<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sunlight + Film Planner POC</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>
  body {
    margin: 0;
    background: #111;
    color: #eee;
    font-family: system-ui, sans-serif;
    display: flex;
  }

  #map { flex: 1; height: 100vh; }

  #panel {
    width: 50%;
    max-width: 560px;
    background: #1c1c1c;
    padding: 16px;
    overflow-y: auto;
    display: none;
  }

  h3, h4 { margin-top: 0; }

  .row { font-size: 14px; margin-bottom: 6px; }

  input, button {
    width: 100%;
    background: #222;
    color: #eee;
    border: 1px solid #444;
    padding: 6px;
    margin-top: 6px;
  }

  .good { color: #FFD700; }
  .bad { color: #777; }

  .film-group {
    margin-top: 10px;
    padding: 8px;
    background: #222;
    border-left: 3px solid #FFD700;
  }

  .film-title {
    font-weight: bold;
    margin-bottom: 4px;
  }

  .saved {
    cursor: pointer;
    font-size: 13px;
    margin-top: 6px;
    opacity: 0.9;
  }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <h3>üìç Light & Film Explorer</h3>

  <input type="date" id="datePicker"/>

  <div id="astro"></div>

  <h4>‚òÄÔ∏è Sun times</h4>
  <div id="sunTimes"></div>

  <h4>üì∑ Golden hour conditions</h4>
  <div id="ghSummary"></div>

  <h4>‚è± Time of day</h4>
  <input type="range" id="timeSlider"/>
  <div id="timeLabel" class="row"></div>

  <h4>üì∏ Current light</h4>
  <div id="conditions"></div>

  <h4>üéû Film suggestions</h4>
  <div id="filmRec"></div>

  <button onclick="saveLocation()">üíæ Save location</button>

  <h4>‚≠ê Saved locations</h4>
  <div id="saved"></div>
</div>

<script>
/* ================= MAP ================= */

const map = L.map("map").setView([54.5, -3], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker, arrow, streetsLayer, buildingsLayer;
let state = null;

map.on("click", e => {
  document.getElementById("panel").style.display = "block";
  map.invalidateSize();

  if (marker) marker.remove();
  marker = L.circleMarker(e.latlng, { radius: 6, color: "#FFD700" }).addTo(map);

  analyseLocation(e.latlng.lat, e.latlng.lng);
});

/* ================= ANALYSIS ================= */

function analyseLocation(lat, lng) {
  const dateVal = document.getElementById("datePicker").value;
  const date = dateVal ? new Date(dateVal) : new Date();
  const times = SunCalc.getTimes(date, lat, lng);

  setupSlider(times);

  fetchBuildings(lat, lng).then(buildings => {
    const ghGood = intervalHasSun(times.goldenHour, times.sunset, lat, lng, buildings);

    state = { lat, lng, date, times, buildings };

    drawBuildings(buildings);
    renderSunTimes(times, ghGood);
    renderAstro(date);
    updateForTime(times.goldenHour);
  });
}

/* ================= SLIDER ================= */

function setupSlider(times) {
  const s = document.getElementById("timeSlider");
  s.min = times.sunrise.getTime();
  s.max = times.sunset.getTime();
  s.step = 5 * 60 * 1000;
  s.value = times.goldenHour.getTime();
  s.oninput = () => updateForTime(new Date(+s.value));
}

/* ================= UPDATE ================= */

function updateForTime(time) {
  if (!state) return;

  const { lat, lng, buildings } = state;
  const pos = SunCalc.getPosition(time, lat, lng);
  const az = (pos.azimuth * 180 / Math.PI + 180) % 360;
  const el = pos.altitude * 180 / Math.PI;

  document.getElementById("timeLabel").textContent =
    `Time: ${time.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;

  drawSunArrow(lat, lng, az);
  renderConditions(lat, lng, az, el, buildings);
  renderFilmSuggestions(time, az, el, buildings);
}

/* ================= FILM RECOMMENDER (LIGHT-ONLY) ================= */

function renderFilmSuggestions(time, az, el, buildings) {
  const scene = deriveSceneCondition(time, az, el, buildings);
  const html = [];

  // COLOUR
  html.push(renderFilmGroup(
    "üé® Colour",
    ["Portra 160", "Portra 400", "Ektar 100"],
    scene,
    "Colour negative film offers latitude and smooth highlight roll-off, ideal for managing contrast and colour shifts in this light."
  ));

  // B&W
  html.push(renderFilmGroup(
    "‚ö´ Black & White",
    ["HP5+", "Tri-X 400", "FP4+"],
    scene,
    "Black & white film handles contrast and shadow detail gracefully, letting form and light take priority."
  ));

  // NIGHT / LOW LIGHT
  if (el < 10) {
    html.push(renderFilmGroup(
      "üåô Night / Low light",
      ["Portra 800", "Cinestill 800T", "Delta 3200"],
      scene,
      "High-speed films cope better with low light and mixed colour temperatures as daylight fades."
    ));
  }

  document.getElementById("filmRec").innerHTML = html.join("");
}

function renderFilmGroup(title, stocks, scene, why) {
  return `
    <div class="film-group">
      <div class="film-title">${title}</div>
      <div>${stocks.join(" / ")}</div>
      <div class="row">${why}</div>
    </div>
  `;
}

/* ================= SCENE ================= */

function deriveSceneCondition(time, az, el, buildings) {
  const direct = sunVisible(state.lat, state.lng, az, el, buildings);
  return {
    directSunVisible: direct,
    contrast: direct && el > 60 ? "High" : direct ? "Medium" : "Low",
    lowLight: el < 10
  };
}

/* ================= EXISTING UTILS ================= */

function drawSunArrow(lat,lng,az){if(arrow)arrow.remove();
const len=0.001,rad=az*Math.PI/180;
arrow=L.polyline([[lat,lng],[lat+Math.cos(rad)*len,lng+Math.sin(rad)*len]],{color:"#FFD700",weight:3}).addTo(map);}

function fetchBuildings(lat,lng){const q=`[out:json];way["building"](around:400,${lat},${lng});out geom tags;`;
return fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:q}).then(r=>r.json())
.then(d=>d.elements.map(b=>({geom:b.geometry,h:parseFloat(b.tags?.height)||(parseFloat(b.tags?.["building:levels"])||3)*3})));}

function drawBuildings(b){if(buildingsLayer)buildingsLayer.remove();
buildingsLayer=L.layerGroup(b.map(x=>L.polygon(x.geom.map(p=>[p.lat,p.lon]),{color:"#555",weight:1,fillOpacity:0.4}))).addTo(map);}

function intervalHasSun(start,end,lat,lng,b){for(let t=new Date(start);t<=end;t.setMinutes(t.getMinutes()+15)){
const p=SunCalc.getPosition(t,lat,lng);const az=(p.azimuth*180/Math.PI+180)%360;const el=p.altitude*180/Math.PI;
if(el>0&&sunVisible(lat,lng,az,el,b))return true;}return false;}

function sunVisible(lat,lng,az,el,b){for(const x of b){
const c=x.geom[0];const d=dist(lat,lng,c.lat,c.lon);const br=bearing(lat,lng,c.lat,c.lon);
if(angleDiff(az,br)<15&&Math.atan2(x.h,d)*180/Math.PI>el)return false;}return true;}

function renderConditions(lat,lng,az,el,b){const g=sunVisible(lat,lng,az,el,b);
document.getElementById("conditions").innerHTML=`<div class="row ${g?"good":"bad"}">${g?"Direct sunlight likely":"Sun obstructed by buildings"}</div>`;}

function renderSunTimes(t,g){const f=x=>new Intl.DateTimeFormat(undefined,{hour:"2-digit",minute:"2-digit"}).format(x);
document.getElementById("sunTimes").innerHTML=`<div class="row">üåÖ Sunrise: ${f(t.sunrise)}</div>
<div class="row">üåá Sunset: ${f(t.sunset)}</div>
<div class="row">üåÑ Golden hour: ${f(t.goldenHour)} ‚Äì ${f(t.sunset)}</div>`;
document.getElementById("ghSummary").innerHTML=`<div class="row ${g?"good":"bad"}">${g?"Golden hour likely good":"Golden hour obstructed"}</div>`;}

function renderAstro(d){const m=SunCalc.getMoonIllumination(d);let t="";
if(m.phase>0.48&&m.phase<0.52){const n=["Wolf","Snow","Worm","Pink","Flower","Strawberry","Buck","Sturgeon","Harvest","Hunter‚Äôs","Beaver","Cold"];
t=`üåï Full Moon (${n[d.getMonth()]} Moon)`;}else if(m.phase<0.02||m.phase>0.98)t="üåë New Moon";
document.getElementById("astro").innerHTML=t?`<div class="row">${t}</div>`:"";}

function saveLocation(){if(!state)return;const title=prompt("Name this location:");
if(!title)return;const s=JSON.parse(localStorage.getItem("saved")||"[]");
s.push({title,lat:state.lat,lng:state.lng});localStorage.setItem("saved",JSON.stringify(s));renderSaved();}

function renderSaved(){const c=document.getElementById("saved");c.innerHTML="";
JSON.parse(localStorage.getItem("saved")||"[]").forEach(p=>{const d=document.createElement("div");
d.className="saved";d.textContent=`üìç ${p.title}`;d.onclick=()=>{map.setView([p.lat,p.lng],17);analyseLocation(p.lat,p.lng);};
c.appendChild(d);});}
renderSaved();

/* ================= MATH ================= */

function bearing(a,b,c,d){const y=Math.sin((d-b)*Math.PI/180)*Math.cos(c*Math.PI/180);
const x=Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos((d-b)*Math.PI/180);
return (Math.atan2(y,x)*180/Math.PI+360)%360;}
function angleDiff(a,b){const d=Math.abs(a-b)%360;return d>180?360-d:d;}
function dist(a,b,c,d){const R=6371000;const dLat=(c-a)*Math.PI/180;const dLon=(d-b)*Math.PI/180;
const h=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
return 2*R*Math.asin(Math.sqrt(h));}
</script>

</body>
</html>
